<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <title>Monitoring SPKLU Kalbar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body { margin:0; font-family: 'Segoe UI', sans-serif; background: #f4f7f6; scroll-behavior: smooth; }
        .navbar { position: fixed; top: 0; width: 100%; height: 50px; background: #1e88e5; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .navbar .menu a { color: white; text-decoration: none; font-weight: bold; padding: 8px 15px; border-radius: 4px; }
        
        /* Layer 1: Map */
        #map-container { height: 100vh; position: relative; padding-top: 50px; box-sizing: border-box; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .panel { position: absolute; top: 70px; left: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.25); width: 280px; max-height: 80vh; overflow-y: auto; }
        .panel label { font-size: 11px; font-weight: bold; display: block; margin-top: 8px; color: #555; }
        .panel input, .panel select { width: 100%; padding: 7px; margin-top: 3px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        .list { margin-top: 15px; border-top: 1px solid #ddd; }
        .list-item { padding: 10px; font-size: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .list-item:hover { background: #f0f7ff; }

        /* Layer 2: Evaluation */
        #evaluation-layer { min-height: 100vh; padding: 80px 20px; background: #fff; }
        .container { max-width: 1100px; margin: auto; }
        .summary-grid { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .sum-card { background: #fff; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px; border-left: 5px solid #1e88e5; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 8px; border: 1px solid #eee; height: 400px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 20px; }
        table th { background: #1e88e5; color: white; padding: 12px; text-align: left; }
        table td { padding: 10px; border-bottom: 1px solid #eee; }
        .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px; }
    </style>
</head>
<body>

    <div class="navbar">
        <b>Monitoring SPKLU Kalbar</b>
        <div class="menu">
            <a href="#map-container">Peta</a>
            <a href="#evaluation-layer">Evaluasi</a>
        </div>
    </div>

    <div id="map-container">
        <div class="panel">
            <h3>Pencarian SPKLU</h3>
            <label>Cari Nama</label>
            <input type="text" id="searchNama" placeholder="Nama stasiun...">
            <label>Filter UP3</label>
            <select id="mapFilterUP3"><option value="all">Semua UP3</option></select>
            <label>Filter Kota</label>
            <select id="mapFilterKota"><option value="all">Semua Kota</option></select>
            <label>Tipe Charger</label>
            <select id="mapFilterType">
                <option value="all">Semua Tipe</option>
                <option value="FAST CHARGING">Fast Charging</option>
                <option value="MEDIUM CHARGING">Medium Charging</option>
                <option value="ULTRA FAST CHARGING">Ultra Fast Charging</option>
            </select>
            <div class="list" id="spkluList"></div>
        </div>
        <div id="map"></div>
    </div>

    <div id="evaluation-layer">
        <div class="container">
            <h2 style="text-align: center;">Dashboard Evaluasi</h2>
            <div class="summary-grid">
                <div class="sum-card"><span>Total Komulatif</span><h2 id="totalValue">0</h2></div>
                <div class="sum-card" style="border-left-color: #43a047;"><span>Jumlah Lokasi</span><h2 id="totalSPKLU" style="color: #43a047;">0</h2></div>
            </div>
            <div class="filter-grid">
                <div class="filter-item">
                    <label>UP3 / Kota</label>
                    <select id="evalFilterGeo">
                        <option value="all">Semua Wilayah</option>
                        <optgroup label="UP3" id="optUP3"></optgroup>
                        <optgroup label="Kota" id="optKota"></optgroup>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Kategori</label>
                    <select id="evalFilterCategory"><option value="kwh">kWh</option><option value="transactions">Transaksi</option></select>
                </div>
                <div class="filter-item">
                    <label>Grafik</label>
                    <select id="evalFilterChartType"><option value="line">Garis</option><option value="bar">Batang</option></select>
                </div>
                <div class="filter-item">
                    <label>Periode</label>
                    <select id="evalFilterTime"><option value="12">1 Tahun</option><option value="all">Semua</option></select>
                </div>
            </div>
            <div class="chart-box"><canvas id="mainChart"></canvas></div>
            <table>
                <thead><tr><th>Nama SPKLU</th><th>UP3 (ULP)</th><th>Bulan</th><th>kWh</th><th>Tx</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div class="pagination">
                <button id="prevBtn">Prev</button><span id="pageInfo">Hal 1</span><button id="nextBtn">Next</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        const URL_SPKLU = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpro3esJDAdEsGRc-UbAtwqsUony4zn4jb6xtuAfAdEaJjtGLCkZMa75qMzi5-pnUdv3uiGfusHr_t/pub?gid=650444376&single=true&output=csv';
        const URL_TX = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpro3esJDAdEsGRc-UbAtwqsUony4zn4jb6xtuAfAdEaJjtGLCkZMa75qMzi5-pnUdv3uiGfusHr_t/pub?gid=2044243535&single=true&output=csv';
        const URL_KWH = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpro3esJDAdEsGRc-UbAtwqsUony4zn4jb6xtuAfAdEaJjtGLCkZMa75qMzi5-pnUdv3uiGfusHr_t/pub?gid=1058603642&single=true&output=csv';

        let map, markers = [], currentChart = null;
        let db = { spklu_data: [], up3_list: [], kota_list: [], date_list: [] };
        let filteredTableData = [], currentPage = 1, rowsPerPage = 10;

        async function fetchData() {
            const fetchCsv = (url) => new Promise((res, rej) => Papa.parse(url, { download: true, header: true, skipEmptyLines: 'greedy', complete: (r) => res(r.data), error:rej }));
            try {
                const [s, t, k] = await Promise.all([fetchCsv(URL_SPKLU), fetchCsv(URL_TX), fetchCsv(URL_KWH)]);
                processData(s, t, k);
                initApp();
            } catch (e) { console.error(e); }
        }

        function processData(spklu, tx, kwh) {
            const dates = Object.keys(tx[0]).filter(k => k !== 'UP3' && k !== 'ULP' && k !== 'Nama Stasiun');
            const kSet = new Set(), uSet = new Set();
            db.spklu_data = spklu.filter(x => x['Nama Stasiun']).map(x => {
                const n = x['Nama Stasiun'].trim();
                uSet.add(x.UP3); kSet.add(x.Kota);
                return { ...x, nama: n, lat: parseFloat(x.Latitude), lon: parseFloat(x.Longitude), tx: tx.find(i => i['Nama Stasiun'] === n) || {}, kwh: kwh.find(i => i['Nama Stasiun'] === n) || {} };
            });
            db.date_list = dates; db.up3_list = [...uSet].sort(); db.kota_list = [...kSet].sort();
        }

        function initApp() {
    // 1. Inisialisasi Peta
    if (map) map.remove();
    map = L.map('map', { zoomControl: false }).setView([-0.03, 109.33], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 2. Definisi Custom Icon berdasarkan tipe
    const icons = {
        "FAST CHARGING": L.icon({
            iconUrl: 'icon/fast.png',
            iconSize: [32, 32], // Ukuran icon (lebar, tinggi)
            iconAnchor: [16, 32], // Titik tumpu icon (tengah bawah)
            popupAnchor: [0, -32] // Posisi popup relatif terhadap icon
        }),
        "MEDIUM CHARGING": L.icon({
            iconUrl: 'icon/mediumfast.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        }),
        "ULTRA FAST CHARGING": L.icon({
            iconUrl: 'icon/ultrafast.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        })
    };

    // 3. Tambah Marker dengan Icon Custom
    db.spklu_data.forEach(d => {
        if (!isNaN(d.lat) && !isNaN(d.lon)) {
            const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${d.lat},${d.lon}`;
            
            // Pilih icon berdasarkan tipe, jika tidak cocok gunakan fast.png sebagai default
            const selectedIcon = icons[d.type] || icons["FAST CHARGING"];

            const m = L.marker([d.lat, d.lon], { icon: selectedIcon }).addTo(map).bindPopup(`
                <div style="min-width:160px; font-family: sans-serif;">
                    <b style="color:#1e88e5; font-size:14px;">${d.nama}</b><br>
                    <small style="color:#666;">${d.alamat}</small><br>
                    <small><b>Tipe:</b> ${d.type}</small><br><br>
                    <a href="${gmapsUrl}" target="_blank" 
                       style="background:#1e88e5; color:white; padding:6px 12px; text-decoration:none; border-radius:4px; font-size:11px; display:inline-block; font-weight:bold;">
                       üìç Petunjuk Rute (Maps)
                    </a>
                </div>
            `);
            m.data = d;
            markers.push(m);
        }
    });

    // 4. Populasi Filter (UP3 & Kota)
    const mapUP3 = document.getElementById('mapFilterUP3');
    const mapKota = document.getElementById('mapFilterKota');
    const optUP3Group = document.getElementById('optUP3');
    const optKotaGroup = document.getElementById('optKota');

    if(mapUP3) mapUP3.innerHTML = '<option value="all">Semua UP3</option>';
    if(mapKota) mapKota.innerHTML = '<option value="all">Semua Kota</option>';
    if(optUP3Group) optUP3Group.innerHTML = '';
    if(optKotaGroup) optKotaGroup.innerHTML = '';

    db.up3_list.forEach(u => {
        if(mapUP3) mapUP3.add(new Option(u, u));
        if(optUP3Group) optUP3Group.appendChild(new Option("UP3 " + u, u));
    });

    db.kota_list.forEach(k => {
        if(mapKota) mapKota.add(new Option(k, k));
        if(optKotaGroup) optKotaGroup.appendChild(new Option(k, k));
    });

    setupEventListeners();
    updateDashboard();
    applyMapFilter();
}

        function setupEvents() {
            ['searchNama', 'mapFilterUP3', 'mapFilterKota', 'mapFilterType'].forEach(id => document.getElementById(id).addEventListener('input', applyMapFilter));
            ['evalFilterGeo', 'evalFilterCategory', 'evalFilterChartType', 'evalFilterTime'].forEach(id => document.getElementById(id).addEventListener('change', updateDashboard));
            document.getElementById('prevBtn').onclick = () => { if(currentPage > 1) { currentPage--; renderTable(); } };
            document.getElementById('nextBtn').onclick = () => { if(currentPage * rowsPerPage < filteredTableData.length) { currentPage++; renderTable(); } };
        }

        function applyMapFilter() {
            const s = document.getElementById('searchNama').value.toLowerCase(), u = document.getElementById('mapFilterUP3').value, k = document.getElementById('mapFilterKota').value, t = document.getElementById('mapFilterType').value, list = document.getElementById('spkluList');
            list.innerHTML = '';
            markers.forEach(m => {
                const d = m.data, match = d.nama.toLowerCase().includes(s) && (u === 'all' || d.UP3 === u) && (k === 'all' || d.Kota === k) && (t === 'all' || d['TYPE CHARGE'] === t);
                if(match) { m.addTo(map); const div = document.createElement('div'); div.className='list-item'; div.innerHTML=`<b>${d.nama}</b>${d.UP3}`; div.onclick=()=> { map.setView([d.lat, d.lon], 14); m.openPopup(); }; list.appendChild(div); } else map.removeLayer(m);
            });
        }

        function updateDashboard() {
            const geo = document.getElementById('evalFilterGeo').value, cat = document.getElementById('evalFilterCategory').value, type = document.getElementById('evalFilterChartType').value, time = document.getElementById('evalFilterTime').value;
            let dates = (time === 'all') ? db.date_list : db.date_list.slice(-parseInt(time));
            const stations = db.spklu_data.filter(s => geo === 'all' || s.UP3 === geo || s.Kota === geo);
            const vals = dates.map(d => stations.reduce((acc, s) => acc + (parseFloat(s[cat === 'kwh' ? 'kwh' : 'tx'][d]) || 0), 0));
            
            document.getElementById('totalValue').innerText = vals.reduce((a,b)=>a+b, 0).toLocaleString() + (cat==='kwh'?' kWh':' Tx');
            document.getElementById('totalSPKLU').innerText = stations.length;
            
            if(currentChart) currentChart.destroy();
            currentChart = new Chart(document.getElementById('mainChart'), { type, data: { labels: dates, datasets: [{ label: cat.toUpperCase(), data: vals, borderColor: '#1e88e5', fill: true }] }, options: { responsive:true, maintainAspectRatio:false } });

            filteredTableData = [];
            stations.forEach(s => dates.forEach(d => filteredTableData.push({ n: s.nama, u: s.UP3, ul: s.ULP, b: d, k: s.kwh[d]||0, t: s.tx[d]||0 })));
            filteredTableData.sort((a,b)=>b.b.localeCompare(a.b));
            currentPage = 1; renderTable();
        }

        function renderTable() {
            const data = filteredTableData.slice((currentPage-1)*rowsPerPage, currentPage*rowsPerPage);
            document.getElementById('tableBody').innerHTML = data.map(r => `<tr><td>${r.n}</td><td>${r.u} (${r.ul})</td><td>${r.b}</td><td>${r.k}</td><td>${r.t}</td></tr>`).join('');
            document.getElementById('pageInfo').innerText = `Hal ${currentPage}`;
        }

        fetchData();
    </script>
</body>
</html>

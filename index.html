<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Dashboard Internal PLN - SPKLU Kalbar</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; }
#map { height:100vh; }

.panel {
  position:absolute;
  top:20px;
  left:20px;
  background:#fff;
  padding:14px;
  border-radius:10px;
  width:330px;
  z-index:1000;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
}

.panel h3 { margin:0 0 10px; text-align:center; }
.panel label { font-size:13px; font-weight:bold; }
.panel select { width:100%; margin-bottom:8px; padding:6px; }

.panel-bottom {
  position:absolute;
  bottom:20px;
  left:20px;
  width:360px;
}
</style>
</head>

<body>

<div class="panel">
  <h3>Peta SPKLU Kalbar</h3>

  <label>Kab/Kota</label>
  <select id="filterKota"><option value="all">Semua</option></select>

  <label>UP3</label>
  <select id="filterUP3"><option value="all">Semua</option></select>
</div>

<div class="panel panel-bottom">
  <h3>Grafik Penggunaan SPKLU</h3>

  <label>Jenis Data</label>
  <select id="jenisGrafik">
    <option value="kwh">kWh</option>
    <option value="trx">Transaksi</option>
  </select>

  <label>Periode</label>
  <select id="periode">
    <option value="24">2 Tahun Terakhir</option>
    <option value="12">1 Tahun Terakhir</option>
  </select>

  <label>UP3</label>
  <select id="grafikUP3"><option value="all">Semua UP3</option></select>

  <canvas id="chartSPKLU" height="180"></canvas>
</div>

<div id="map"></div>

<script>
// =================== URL GOOGLE SHEET ===================
const SHEET_PETA = 'https://docs.google.com/spreadsheets/d/1isryqrJuTnQFT8UyQTlnRjxauNCCNfsjErmm07Mwm4g/edit?hl=id&gid=650444376#gid=650444376';
const SHEET_KWH  = 'https://docs.google.com/spreadsheets/d/1isryqrJuTnQFT8UyQTlnRjxauNCCNfsjErmm07Mwm4g/edit?hl=id&gid=2044243535#gid=2044243535';
const SHEET_TRX  = 'https://docs.google.com/spreadsheets/d/1isryqrJuTnQFT8UyQTlnRjxauNCCNfsjErmm07Mwm4g/edit?hl=id&gid=1058603642#gid=1058603642';

// =================== MAP ===================
const map = L.map('map').setView([0.1,109.5],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const icons = {
  "FAST CHARGING": L.icon({iconUrl:'icon/fast.png', iconSize:[28,28]}),
  "MEDIUM CHARGING": L.icon({iconUrl:'icon/mediumfast.png', iconSize:[28,28]}),
  "ULTRA FAST CHARGING": L.icon({iconUrl:'icon/ultrafast.png', iconSize:[28,28]})
};

let markers = [];
let allData = [];

// =================== LOAD PETA ===================
fetch(SHEET_PETA)
.then(r=>r.text())
.then(text=>{
  const rows = text.trim().split('\n').slice(1);
  const kotaSet = new Set();
  const up3Set = new Set();

  rows.forEach(r=>{
    const c = r.split(',');
    const d = {
      nama:c[0], alamat:c[1],
      lat:+c[2], lon:+c[3],
      prov:c[4], kota:c[5],
      type:c[6], kw:c[7],
      up3:c[8], ulp:c[9]
    };
    if(isNaN(d.lat)) return;

    kotaSet.add(d.kota);
    up3Set.add(d.up3);

    const m = L.marker([d.lat,d.lon],{icon:icons[d.type]})
      .bindPopup(`
        <b>${d.nama}</b><br>
        ${d.alamat}<br>
        ${d.kota}<br>
        ${d.type} (${d.kw} kW)<br>
        UP3 ${d.up3} - ${d.ulp}
      `).addTo(map);

    m.data=d;
    markers.push(m);
    allData.push(d);
  });

  isiSelect('filterKota',kotaSet);
  isiSelect('filterUP3',up3Set);
  isiSelect('grafikUP3',up3Set);
});

function isiSelect(id,set){
  const s=document.getElementById(id);
  [...set].sort().forEach(v=>{
    const o=document.createElement('option');
    o.value=v; o.text=v;
    s.appendChild(o);
  });
}

// =================== FILTER MAP ===================
function applyMapFilter(){
  const kota=filterKota.value;
  const up3=filterUP3.value;

  markers.forEach(m=>{
    const d=m.data;
    if((kota==='all'||d.kota===kota) &&
       (up3==='all'||d.up3===up3)){
      map.addLayer(m);
    } else map.removeLayer(m);
  });
}

filterKota.onchange=filterUP3.onchange=applyMapFilter;

// =================== GRAFIK ===================
let dataKWH=[], dataTRX=[], chart;

Promise.all([
  fetch(SHEET_KWH).then(r=>r.text()),
  fetch(SHEET_TRX).then(r=>r.text())
]).then(([kwh,trx])=>{
  dataKWH=parseBulanan(kwh);
  dataTRX=parseBulanan(trx);
  updateChart();
});

function parseBulanan(text){
  const rows=text.trim().split('\n');
  const header=rows[0].split(',').slice(1);
  return rows.slice(1).map(r=>{
    const c=r.split(',');
    return {
      nama:c[0],
      values:header.map((h,i)=>({bulan:h, nilai:+c[i+1]}))
    };
  });
}

function updateChart(){
  const jenis=jenisGrafik.value;
  const periode=+periodeSelect.value;
  const up3=grafikUP3.value;

  const src=jenis==='kwh'?dataKWH:dataTRX;
  const bulan=src[0].values.slice(-periode).map(v=>v.bulan);

  const total=new Array(bulan.length).fill(0);
  src.forEach(s=>{
    s.values.slice(-periode).forEach((v,i)=>{
      total[i]+=v.nilai;
    });
  });

  if(chart) chart.destroy();
  chart=new Chart(chartSPKLU,{
    type:'bar',
    data:{labels:bulan,
      datasets:[{
        label: jenis==='kwh'?'Total kWh':'Jumlah Transaksi',
        data:total,
        backgroundColor:'#1e88e5'
      }]
    }
  });
}

const periodeSelect=document.getElementById('periode');
[jenisGrafik,periodeSelect,grafikUP3]
.forEach(e=>e.onchange=updateChart);
</script>

</body>
</html>

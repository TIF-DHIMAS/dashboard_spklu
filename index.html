<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Dashboard Internal PLN â€“ SPKLU Kalbar</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin:0; font-family:Arial,sans-serif; }

/* ===== PETA ===== */
#map { height:65vh; }

/* ===== PANEL FILTER PETA ===== */
.panel {
  position:absolute;
  top:20px;
  left:20px;
  z-index:1000;
  background:#fff;
  padding:14px;
  border-radius:10px;
  width:320px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
}

.panel h3 { margin:0 0 10px; text-align:center; }
.panel label { font-size:13px; font-weight:bold; }
.panel input, .panel select {
  width:100%;
  margin-bottom:8px;
  padding:6px;
}

/* ===== AREA GRAFIK ===== */
#chartArea {
  height:35vh;
  border-top:4px solid #ddd;
  padding:12px 20px;
  background:#fafafa;
}

#chartArea select {
  padding:6px;
  font-size:13px;
  margin-right:6px;
}

#chartSPKLU { max-height:220px; }
</style>
</head>

<body>

<!-- PANEL FILTER PETA -->
<div class="panel">
  <h3>Peta SPKLU Kalbar</h3>

  <label>Cari Nama SPKLU</label>
  <input type="text" id="searchNama" placeholder="Nama SPKLU">

  <label>Kabupaten / Kota</label>
  <select id="filterKota">
    <option value="all">Semua</option>
  </select>

  <label>Tipe Charging</label>
  <select id="filterType">
    <option value="all">Semua</option>
    <option value="FAST CHARGING">Fast</option>
    <option value="MEDIUM CHARGING">Medium</option>
    <option value="ULTRA FAST CHARGING">Ultra</option>
  </select>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- ===== AREA GRAFIK ===== -->
<div id="chartArea">

  <div style="margin-bottom:10px">
    <select id="jenisGrafik">
      <option value="kwh">kWh</option>
      <option value="trx">Transaksi</option>
    </select>

    <select id="periode">
      <option value="24">2 Tahun Terakhir</option>
      <option value="12">1 Tahun Terakhir</option>
    </select>

    <select id="filterUP3Grafik">
      <option value="all">Semua UP3</option>
    </select>
  </div>

  <canvas id="chartSPKLU"></canvas>

</div>

<script>
// ================= URL GOOGLE SHEET =================
const SHEET_PETA = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpro3esJDAdEsGRc-UbAtwqsUony4zn4jb6xtuAfAdEaJjtGLCkZMa75qMzi5-pnUdv3uiGfusHr_t/pub?gid=650444376&single=true&output=csv';
const SHEET_KWH  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpro3esJDAdEsGRc-UbAtwqsUony4zn4jb6xtuAfAdEaJjtGLCkZMa75qMzi5-pnUdv3uiGfusHr_t/pub?gid=1058603642&single=true&output=csv';
const SHEET_TRX  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpro3esJDAdEsGRc-UbAtwqsUony4zn4jb6xtuAfAdEaJjtGLCkZMa75qMzi5-pnUdv3uiGfusHr_t/pub?gid=2044243535&single=true&output=csv';

// ================= MAP =================
const map = L.map('map').setView([0.1,109.5],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const icons = {
  "FAST CHARGING": L.icon({iconUrl:'icon/fast.png', iconSize:[30,30]}),
  "MEDIUM CHARGING": L.icon({iconUrl:'icon/mediumfast.png', iconSize:[30,30]}),
  "ULTRA FAST CHARGING": L.icon({iconUrl:'icon/ultrafast.png', iconSize:[30,30]})
};

let markers = [];
let allData = [];

// ================= LOAD DATA PETA =================
fetch(SHEET_PETA)
.then(r=>r.text())
.then(text=>{
  const rows = text.trim().split('\n').slice(1);
  const kotaSet = new Set();

  rows.forEach(r=>{
    const c = r.split(',');
    const d = {
      nama:c[0], alamat:c[1],
      lat:+c[2], lon:+c[3],
      kota:c[5], type:c[6], kw:c[7]
    };
    if(isNaN(d.lat)) return;

    allData.push(d);
    kotaSet.add(d.kota);

    const m = L.marker([d.lat,d.lon],{icon:icons[d.type]})
      .bindPopup(`
        <b>${d.nama}</b><br>
        ${d.alamat}<br>
        ${d.kota}<br>
        ${d.type} (${d.kw} kW)
      `).addTo(map);

    m.data=d;
    markers.push(m);
  });

  kotaSet.forEach(k=>{
    const o=document.createElement('option');
    o.value=k; o.textContent=k;
    filterKota.appendChild(o);
  });

  applyFilter();
});

// ================= FILTER PETA =================
function applyFilter(){
  const key=searchNama.value.toLowerCase();
  const kota=filterKota.value;
  const type=filterType.value;

  markers.forEach(m=>{
    const d=m.data;
    const ok =
      d.nama.toLowerCase().includes(key) &&
      (kota==='all'||d.kota===kota) &&
      (type==='all'||d.type===type);

    ok ? map.addLayer(m) : map.removeLayer(m);
  });
}

searchNama.oninput=filterKota.onchange=filterType.onchange=applyFilter;

// ================= GRAFIK =================
let dataKWH=[], dataTRX=[], chart;

Promise.all([
  fetch(SHEET_KWH).then(r=>r.text()),
  fetch(SHEET_TRX).then(r=>r.text())
]).then(([kwh,trx])=>{
  dataKWH=parseBulanan(kwh);
  dataTRX=parseBulanan(trx);
  isiUP3();
  updateChart();
});

function parseBulanan(text){
  const rows=text.trim().split('\n');
  const header=rows[0].split(',').slice(1);
  return rows.slice(1).map(r=>{
    const c=r.split(',');
    return {
      nama:c[0],
      values:header.map((h,i)=>({bulan:h, nilai:+c[i+1]}))
    };
  });
}

function isiUP3(){
  ['21PTK','21SKW','21KTP','21MPW','21SGU']
  .forEach(u=>{
    const o=document.createElement('option');
    o.value=u; o.textContent=u;
    filterUP3Grafik.appendChild(o);
  });
}

function updateChart(){
  const jenis=jenisGrafik.value;
  const periode=+document.getElementById('periode').value;
  const src=jenis==='kwh'?dataKWH:dataTRX;

  if(!src.length) return;

  const labels=src[0].values.slice(-periode).map(v=>v.bulan);
  const total=new Array(labels.length).fill(0);

  src.forEach(s=>{
    s.values.slice(-periode).forEach((v,i)=>{
      total[i]+=v.nilai;
    });
  });

  if(chart) chart.destroy();
  chart=new Chart(chartSPKLU,{
    type:'bar',
    data:{
      labels:labels,
      datasets:[{
        label: jenis==='kwh'?'Total kWh':'Jumlah Transaksi',
        data:total,
        backgroundColor:'#1e88e5'
      }]
    }
  });
}

[jenisGrafik,periode,filterUP3Grafik].forEach(e=>e.onchange=updateChart);
</script>

</body>
</html>
